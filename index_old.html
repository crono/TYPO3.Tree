<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link type="text/css" rel="stylesheet" href="style.css"/>
  <link type="text/css" rel="stylesheet" href="font-awesome.css"/>
  <script type="text/javascript" src="bower_components/fastclick/lib/fastclick.js"></script>
  <script type="text/javascript" src="bower_components/underscore/underscore.js"></script>
  <script type="text/javascript" src="bower_components/d3/d3.js"></script>
</head>
<body>

<div id="body"></div>

<script type="text/javascript">
  "use strict";

  var nodeHeight = 20;
  var indentWidth = 16;
  var duration = 400;
  var viewportHeight, scrollTop, scrollHeight, scrollBottom;
  var tree = d3.layout.tree();
  var svg = d3
      .select("#body")
      .append("svg")
      .attr('version', '1.1');
  var iconElements = svg.append('defs');
  var dragElement = svg
      .append('rect')
      .attr('visibility', 'hidden')
      .attr('x', 0)
      .attr('y', 0)
      .style('fill', '#D6E7F7')
      .attr('width', '100%')
      .attr('height', nodeHeight);
  var container = svg
      .append("g")
      .attr("transform", "translate(" + (indentWidth / 2)  + "," + (nodeHeight / 2) + ")");
  var linkElements = container.append('g')
      .attr('class', 'links');
  var nodeElements = container.append('g')
      .attr('class', 'nodes');
  var drag = d3.behavior.drag()
      .origin(Object)
      .on("dragstart", dragstart)
      .on("drag", dragmove)
      .on("dragend", dragend);
  var root = null;

  updateScrollPosition();

  d3.json("bigdata.json", function (error, flare) {
    if (error) throw error;
    flare = tree.nodes(flare);
    flare.forEach(function(n, i) {
      n.open = true;
      n.hasChildren = (n.children || n._children) ? 1 : 0;
      n.parents = [];
      n._isDragged = false;
      if (n.parent) {
        var x = n;
        while (x && x.parent) {
          if (x.parent.identifier) {
            n.parents.push(x.parent.identifier);
          }
          x = x.parent;
        }
      }
    });
    root = flare;
    renderData();
    update();
  });

  function squaredDiagonal(d) {
    var target = {
      x: d.target._isDragged ? d.target._x : d.target.x,
      y: d.target._isDragged ? d.target._y : d.target.y
    };
    var path = [];
    path.push('M' + d.source.x + " " + d.source.y);
    path.push('V' + target.y);
    if (target.hasChildren) {
      path.push('H' + target.x);
    } else {
      path.push('H' + (target.x + indentWidth / 4));
    }
    return path.join(' ');
  }

  function xy(d) {
    return "translate(" + d.x + "," + d.y + ")";
  }

  function hashCode(s){
    return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
  }

  var data = {};
  function renderData() {
    var blacklist = {};
    root.forEach(function(node) {
      if (!node.open) {
        blacklist[node.identifier] = true;
      }
    });
    data.nodes = root.filter(function(node) {
      return !node.parents.some(function(id) {
        return Boolean(blacklist[id]);
      });
    });
    var iconHashes = [];
    data.links = [];
    data.icons = [];
    data.nodes.forEach(function(n, i) {
      delete n.children;
      n.x = n.depth * indentWidth;
      n.y = i * nodeHeight;
      if (n.parent) {
        data.links.push({
          source: n.parent,
          target: n
        });
      }
      if (!n.iconHash) {
        n.iconHash = Math.abs(hashCode(n.icon));
        if (iconHashes.indexOf(n.iconHash) === -1) {
          iconHashes.push(n.iconHash);
          data.icons.push({
            identifier: n.iconHash,
            icon: n.icon
          });
        }
        delete n.icon;
      }
    });
  }

  function update() {
    var visibleRows = Math.ceil(viewportHeight / nodeHeight + 1);
    var position = Math.floor(Math.max(scrollTop, 0) / nodeHeight);
    var visibleNodes = data.nodes.slice(position, position + visibleRows);
    var visibleLinks = data.links.filter(function(d) {
      return d.source.y <= scrollBottom && scrollTop <= d.target.y;
    });

    svg.attr('height', data.nodes.length * nodeHeight);

    var icons = iconElements
        .selectAll(".icon-def")
        .data(data.icons, function(i) { return i.identifier; });

    icons
        .enter()
        .append('g')
        .attr('class', 'icon-def')
        .attr('id', function(i) { return 'icon-' + i.identifier; })
        .html(function(i) { return i.icon.replace('<svg', '<g').replace('/svg>', '/g>'); });

    var links = linkElements
        .selectAll(".link")
        .data(visibleLinks);

    // create
    links
        .enter()
        .append("path")
        .attr("class", "link");

    // update
    links
        .attr("d", squaredDiagonal);

    // delete
    links
        .exit()
        .remove();

    var nodes = nodeElements
        .selectAll(".node")
        .data(visibleNodes);

    // create
    var nodeEnter = nodes
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", xy)
        .call(drag);
    var chevron = nodeEnter
        .append('g')
        .attr('class', 'toggle')
        .on('click', click);
    chevron // improve usability by making the clickarea a 16px square
        .append('path')
        .style('opacity', 0)
        .attr('d', 'M 0 0 L 16 0 L 16 16 L 0 16 Z');
    chevron
        .append('path')
        .attr('class', 'chevron')
        .attr('d', 'M 4 3 L 13 8 L 4 13 Z');
    var use = nodeEnter
        .append('use')
        .attr('x', 8)
        .attr('y', -8);
    nodeEnter
        .append('text')
        .attr("dx", 27)
        .attr("dy", 5);

    // update
    nodes
        .attr("transform", xy)
        .select('text')
        .text(function(d) { return d.name; });
    nodes
        .select('.toggle')
        .attr("transform", function(d) { return d.open ? 'translate(8 -8) rotate(90)' : 'translate(-8 -8) rotate(0)' ; })
        .attr("visibility", function(d) { return d.hasChildren ? 'visible' : 'hidden'; });
    nodes
        .select('use')
        .attr('xlink:href', function(n) { return '#icon-' + n.iconHash; });

    // delete
    nodes
        .exit()
        .remove();
  }

  function hideChildren(d) {
    d.open = false;
    renderData();
    update();
  }

  function showChildren(d) {
    d.open = true;
    renderData();
    update();
  }

  function click(d) {
    if (d.open) {
      hideChildren(d);
    } else {
      showChildren(d);
    }
    update();
  }

  d3.select(document).on('scroll', function() {
    updateScrollPosition();
    update();
  });

  function updateScrollPosition() {
    viewportHeight = parseInt(window.innerHeight);
    scrollTop = window.scrollY - (viewportHeight / 2);
    scrollHeight = parseInt(window.document.body.clientHeight);
    scrollBottom = scrollTop + viewportHeight + (viewportHeight / 2);
    viewportHeight = viewportHeight * 2;
  }

  function dragstart(d) {
    d._isDragged = true;
  }

  var lastDragY;
  var throttledDragmove = _.throttle(function() {
    var currentRow = (Math.round(( lastDragY / nodeHeight ) * 2) / 2);
    var dragElementHeight = currentRow % 1 ? 1 : nodeHeight;
    var dragElementY = (currentRow * nodeHeight) + (currentRow % 1 ? (nodeHeight / 2) : 0);
    dragElement
        .attr('visibility', 'visible')
        .attr('transform', xy({x:0, y: dragElementY}))
        .attr('height', dragElementHeight);
  }, 40);

  function dragmove(d) {
    lastDragY = d3.event.y;
    throttledDragmove(d);
  }

  function dragend(d) {
    d._isDragged = false;
    dragElement
        .attr('visibility', 'hidden');
  return;
    var currentRow = (Math.round(( lastDragY / nodeHeight ) * 2) / 2);
    var elementBeforePosition = Math.floor(currentRow);
    var elementBefore = root[elementBeforePosition];
    var elementAfter = root[elementBeforePosition + 1];
    if (currentRow % 1) {
      insertBetween(elementBefore, elementAfter);
    } else {

    }
  }

  function insertBetween(before, after) {

  }

  document.addEventListener('DOMContentLoaded', function() {
    FastClick.attach(document.getElementById('body'));
  }, false);
</script>
</body>
</html>
